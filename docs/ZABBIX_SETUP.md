# Настройка Zabbix для отправки в Telegram

Ниже — детальные шаги для настройки встроенного media type "Telegram" в Zabbix, добавления медиа пользователю и создания action для отправки алертов.

Предпосылки:
- У вас есть токен бота от @BotFather (см. `.env` → `TELEGRAM_BOT_TOKEN`).
- ID чата (для личных сообщений — ваш user ID, например `1349552926`).
- Наш контейнер с ботом запущен (необязательно для отправки Zabbix → Telegram, но полезно для проверки команд).

## 1. Тест media type "Telegram"
1) Zabbix → Administration → Media types → Telegram → Test.
2) Поля:
   - Token: вставьте токен вашего бота из @BotFather.
   - To: укажите chat ID (для личного чата — ваш user ID, например `1349552926`).
3) Нажмите Test. Должно прийти сообщение в Telegram.

Подсказки:
- Если отправляете в группу/супергруппу/канал:
  - Добавьте бота в группу/канал и дайте ему право писать. Для канала — сделайте бот-аккаунт администратором.
  - Узнать chat ID можно через сторонние боты (например, @RawDataBot) или журнал обновлений (если вы пишете свой код). Для каналов chat ID обычно имеет вид `-100xxxxxxxxxx`.
- Если сообщение не приходит:
  - Проверьте правильность токена.
  - Убедитесь, что бот не заблокирован пользователем/чатом и имеет право писать.

## 2. Привязать медиа к пользователю
1) Zabbix → Administration → Users → выберите нужного пользователя (например, Admin).
2) Вкладка Media → Add:
   - Type: Telegram
   - Send to: укажите chat ID (например, `1349552926`).
   - (Опционально) если шаблон media type требует Token на этом уровне — укажите токен.
   - Enabled: включено.
   - Временное окно (если нужно): по умолчанию 1-7,00:00-24:00.
3) Сохраните.

## 3. Создать Action
1) Zabbix → Configuration → Actions → Create action.
2) Вкладка Action:
   - Name: например, "Send Telegram alerts".
   - Conditions: добавьте условия по необходимости (по узлам/группам/серьезности и т.д.).
3) Вкладка Operations → New:
   - Send to Users: выберите пользователя, которому вы добавили медиа (например, Admin).
   - Send only to: Telegram.
   - Message subject: `{HOST.NAME} | Problem: {EVENT.NAME}`
   - Message:
     ```
     Problem started at {EVENT.TIME} on {EVENT.DATE}
     Problem name: {EVENT.NAME}
     Host: {HOST.NAME}
     Severity: {TRIGGER.SEVERITY}
     Original problem ID: #{EVENT.ID}
     {TRIGGER.URL}
     ```
4) (Рекомендуется) Вкладка Recovery operations → New: добавьте сообщение о восстановлении.
5) (Опционально) Update operations: для периодических обновлений по инциденту.
6) Сохраните Action.

## 4. Проверка
- Вызовите триггер, например, изменив IP адрес хоста на заведомо неверный, чтобы получить недоступность.
- Дождитесь срабатывания триггера — сообщение должно прийти в Telegram чат.
- После восстановления — должно прийти сообщение о восстановлении (если настроили Recovery operations).

## Частые проблемы
- Неверный chat ID: личный ID — просто число (например, `1349552926`); у каналов и супергрупп часто вид `-100xxxxxxxxxx`.
- Бот не в группе/канале или не имеет прав — добавьте/выдайте права.
- Сообщения о разных типах событий приходят не всем — проверьте Conditions в Action и Media привязку к пользователю.
- Дубликаты сообщений — проверьте дублирующиеся Actions или медиа у нескольких пользователей.

